<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>聊天 + 图片</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .msg { border:1px solid #ccc; padding:10px; border-radius:8px; margin:8px 0; }
    img { max-width: 100%; border-radius: 6px; margin-top: 6px; }
  </style>
</head>
<body>

<h2>留言板（支持图片）</h2>

<form id="form">
  <input name="name" placeholder="名字(可空)" style="width:120px;">
  <input name="text" placeholder="说点什么..." required style="width:200px;">
  <input type="file" name="photo" accept="image/*">
  <button>发送</button>
</form>

<hr>

<div id="msgs">加载中...</div>

<script>
async function loadMsgs(){
  const res = await fetch('/api/messages');
  if (!res.ok) { document.getElementById('msgs').innerText='获取失败'; return; }
  const arr = await res.json();

  const box = document.getElementById('msgs');
  box.innerHTML = "";

  arr.forEach(m => {
    const d = document.createElement('div');
    d.className = "msg";
    d.innerHTML = `
      <b>${m.name||"匿名"}</b> — <small>${m.created_at||""}</small><br>
      ${m.text}
    `;
    if (m.photo_url){
      const img = document.createElement('img');
      img.src = m.photo_url;
      d.appendChild(img);
    }
    box.appendChild(d);
  });
}

document.getElementById('form').onsubmit = async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);

  const res = await fetch('/api/post', { method:"POST", body:fd });
  if (!res.ok){ alert("发送失败"); return; }

  e.target.reset();
  loadMsgs();
};

loadMsgs();
setInterval(loadMsgs, 5000);
</script>

</body>
</html>
